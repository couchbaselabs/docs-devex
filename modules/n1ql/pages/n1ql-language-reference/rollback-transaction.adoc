= ROLLBACK TRANSACTION
:description: The ROLLBACK TRANSACTION statement enables you to rollback a transaction.
:page-topic-type: reference
:imagesdir: ../../assets/images

// Cross-references
:transactions: xref:n1ql:n1ql-language-reference/transactions.adoc
:preparation: xref:n1ql:n1ql-language-reference/transactions.adoc#preparation

// Related links
:overview: xref:server:learn:data/transactions.adoc
:begin-transaction: xref:n1ql-language-reference/begin-transaction.adoc
:set-transaction: xref:n1ql-language-reference/set-transaction.adoc
:savepoint: xref:n1ql-language-reference/savepoint.adoc
:commit-transaction: xref:n1ql-language-reference/commit-transaction.adoc
:rollback-transaction: xref:n1ql-language-reference/rollback-transaction.adoc

[abstract]
{description}

== Purpose

The `ROLLBACK TRANSACTION` statement enables you to rollback an ACID transaction.
You can rollback the entire transaction, or rollback to a previous savepoint.
Refer to {transactions}[] for further information.

This statement may only be used within a transaction.

include::partial$n1ql-language-reference/transaction-id.adoc[]

When you rollback the entire transaction, this statement removes all savepoints within the transaction.

ifdef::flag-devex-command-line[]
NOTE: If you are using the cbq shell, and a transaction fails for any reason, you must use the `ROLLBACK TRANSACTION` statement to remove the transaction context and reset the transaction ID.
endif::flag-devex-command-line[]

== Syntax

[source,ebnf]
----
include::partial$grammar/tcl.ebnf[tag=rollback-transaction]
----

image::n1ql-language-reference/rollback-transaction.png["Syntax diagram: refer to source code listing", align=left]

The `WORK`, `TRAN`, and `TRANSACTION` keywords are synonyms.
These keywords are optional; you may include one of these keywords, or omit them entirely.

=== Rollback to a Savepoint

The `TO SAVEPOINT` clause enables you to rollback to a specified savepoint.
This clause is optional.
If omitted, the entire transaction is rolled back.

savepointname::
An identifier specifying a name for the savepoint.

== Examples

If you want to try these examples, first refer to {preparation}[Preparation] to set up your environment.

[[ex-1]]
.Rollback a transaction
====
// Line highlighting doesn't work with highlight.js.
// Markup for future use [source,n1ql,highlight=47..48;57..58]

.Transaction
[source,sqlpp,subs=macros]
----
-- Start the transaction
BEGIN WORK;

-- Specify transaction settings
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

-- Create a booking document
UPSERT INTO bookings
VALUES("42641d7a-cde3-4a4d-bfd5-fec321510f70", {
  "date": "07/24/2021",
  "flight": "WN533",
  "flighttime": 7713,
  "price": 964.13,
  "route": "63986"
});

-- Set a savepoint
SAVEPOINT s1;

-- Update the booking document to include a user
UPDATE bookings AS b
SET b.`user` = "0"
WHERE META(b).id = "42641d7a-cde3-4a4d-bfd5-fec321510f70";

-- Check the content of the booking and user
SELECT b.*, u.name
FROM bookings b
JOIN users u
ON b.`user` = META(u).id
WHERE META(b).id = "42641d7a-cde3-4a4d-bfd5-fec321510f70";

-- Set a second savepoint
SAVEPOINT s2;

-- Update the booking documents to change the user
UPDATE bookings AS b
SET b.`user` = "1"
WHERE META(b).id = "42641d7a-cde3-4a4d-bfd5-fec321510f70";

-- Check the content of the booking and user
SELECT b.*, u.name
FROM bookings b
JOIN users u
ON b.`user` = META(u).id
WHERE META(b).id = "42641d7a-cde3-4a4d-bfd5-fec321510f70";

-- pass:[<mark>Roll back the transaction to the second savepoint</mark>]
ROLLBACK TRAN TO SAVEPOINT s2;

-- Check the content of the booking and user again
SELECT b.*, u.name
FROM bookings b
JOIN users u
ON b.`user` = META(u).id
WHERE META(b).id = "42641d7a-cde3-4a4d-bfd5-fec321510f70";

-- pass:[<mark>Roll back the entire transaction</mark>]
ROLLBACK WORK;
----

.Results
[source,json]
----
[
  {
    "batchQuery": "-- Start the transaction\nBEGIN WORK;",
    "batchQueryResult": [
      {
        "nodeUUID": "d6256523500cb51d6c3ff4ad5798f8c1",
        "txid": "be24d87d-7288-49a1-b2f4-e2bc920d075b"
      }
    ]
  },
  {
    "batchQuery": "\n\n-- Specify transaction settings\nSET TRANSACTION ISOLATION LEVEL READ COMMITTED;",
    "batchQueryResult": []
  },
  {
    "batchQuery": "\n\n-- Create a booking document\nUPSERT INTO bookings\nVALUES(\"42641d7a-cde3-4a4d-bfd5-fec321510f70\", {\n  \"date\": \"07/24/2021\",\n  \"flight\": \"WN533\",\n  \"flighttime\": 7713,\n  \"price\": 964.13,\n  \"route\": \"63986\"\n});",
    "batchQueryResult": []
  },
  {
    "batchQuery": "\n\n-- Set a savepoint\nSAVEPOINT s1;",
    "batchQueryResult": []
  },
  {
    "batchQuery": "\n\n-- Update the booking document to include a user\nUPDATE bookings AS b\nSET b.`user` = \"0\"\nWHERE META(b).id = \"42641d7a-cde3-4a4d-bfd5-fec321510f70\";",
    "batchQueryResult": []
  },
  {
    "batchQuery": "\n\n-- Check the content of the booking and user\nSELECT b.*, u.name\nFROM bookings b\nJOIN users u\nON b.`user` = META(u).id\nWHERE META(b).id = \"42641d7a-cde3-4a4d-bfd5-fec321510f70\";",
    "batchQueryResult": [
      {
        "date": "07/24/2021",
        "flight": "WN533",
        "flighttime": 7713,
        "price": 964.13,
        "route": "63986",
        "user": "0",
        "name": "Keon Hoppe" // <.>
      }
    ]
  },
  {
    "batchQuery": "\n\n-- Set a second savepoint\nSAVEPOINT s2;",
    "batchQueryResult": []
  },
  {
    "batchQuery": "\n\n-- Update the booking documents to change the user\nUPDATE bookings AS b\nSET b.`user` = \"1\"\nWHERE META(b).id = \"42641d7a-cde3-4a4d-bfd5-fec321510f70\";",
    "batchQueryResult": []
  },
  {
    "batchQuery": "\n\n-- Check the content of the booking and user\nSELECT b.*, u.name\nFROM bookings b\nJOIN users u\nON b.`user` = META(u).id\nWHERE META(b).id = \"42641d7a-cde3-4a4d-bfd5-fec321510f70\";",
    "batchQueryResult": [
      {
        "date": "07/24/2021",
        "flight": "WN533",
        "flighttime": 7713,
        "price": 964.13,
        "route": "63986",
        "user": "1",
        "name": "Rigoberto Bernier" // <.>
      }
    ]
  },
  {
    "batchQuery": "\n\n-- Roll back the transaction to the second savepoint\nROLLBACK TRAN TO SAVEPOINT s2;",
    "batchQueryResult": []
  },
  {
    "batchQuery": "\n\n-- Check the content of the booking and user again\nSELECT b.*, u.name\nFROM bookings b\nJOIN users u\nON b.`user` = META(u).id\nWHERE META(b).id = \"42641d7a-cde3-4a4d-bfd5-fec321510f70\";",
    "batchQueryResult": [
      {
        "date": "07/24/2021",
        "flight": "WN533",
        "flighttime": 7713,
        "price": 964.13,
        "route": "63986",
        "user": "0",
        "name": "Keon Hoppe" // <.>
      }
    ]
  },
  {
    "batchQuery": "\n\n-- Roll back the entire transaction\nROLLBACK WORK;",
    "batchQueryResult": []
  }
]
----

<.> Before setting the second savepoint, the booking document has user `"0"`, name `"Keon Hoppe"`.
<.> After setting the second savepoint and performing an update, the booking document has user `"1"`, name `"Rigoberto Bernier"`.
<.> After rolling back to the second savepoint, the booking document again has user `"0"`, name `"Keon Hoppe"`.
====

[[ex-2]]
.Check the result of <<ex-1>>
====
Check the result of rolling back the transaction.

.Query
[source,sqlpp]
----
SELECT b.*, u.name
FROM bookings b
JOIN users u
ON b.`user` = META(u).id
WHERE META(b).id = "42641d7a-cde3-4a4d-bfd5-fec321510f70";
----

.Results
[source,json]
----
[]
----

Notice the booking document no longer exists.
====

== Related Links

* For an overview of Couchbase transactions, refer to {overview}[].
* To begin a transaction, refer to {begin-transaction}[].
* To specify transaction settings, refer to {set-transaction}[].
* To set a savepoint, refer to {savepoint}[].
* To commit a transaction, refer to {commit-transaction}[].
* Blog post: https://blog.couchbase.com/transactions-n1ql-couchbase-distributed-nosql/[Couchbase Transactions: Elastic, Scalable, and Distributed^].